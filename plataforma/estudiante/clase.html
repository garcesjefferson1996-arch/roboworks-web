<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Clase - RoboWorks</title>
    <link rel="stylesheet" href="/css/plataforma.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="/assets/icons/favicon.ico">
    
    <!-- Script de configuraci√≥n centralizada -->
    <script src="/plataforma/js/config.js"></script>
</head>
<body class="plataforma-body">
    <header class="plataforma-header">
        <a href="dashboard.html" class="header-back">
            <i class="fas fa-arrow-left"></i>
        </a>
        <div class="header-logo">
            <img src="/assets/icons/logo.png" alt="Logo" height="30">
        </div>
        <div class="header-user">
            <span class="user-avatar" id="user-avatar">
                <i class="fas fa-robot"></i>
            </span>
        </div>
    </header>

    <main class="clase-container">
        <section class="clase-hero">
            <span class="clase-etiqueta" id="clase-etiqueta">Cargando clase...</span>
            <h1 class="clase-titulo" id="clase-titulo">Bienvenido a tu clase</h1>
            <p class="clase-subtitulo" id="clase-subtitulo">Preparando tu experiencia robotista...</p>
            
            <div class="clase-info-horario">
                <div class="info-item">
                    <i class="far fa-calendar"></i>
                    <span id="fecha-hoy">Cargando fecha...</span>
                </div>
                <div class="info-item">
                    <i class="far fa-clock"></i>
                    <span id="clase-horario">-</span>
                </div>
            </div>
        </section>

        <section class="clase-card card-objetivo">
            <h2><i class="fas fa-bullseye"></i> Objetivo de la Clase</h2>
            <p id="clase-objetivo">Cargando informaci√≥n de la clase...</p>
        </section>

        <!-- SECCI√ìN ZOOM DIN√ÅMICA -->
        <section class="clase-card card-zoom" id="zoom-section">
            <h2><i class="fas fa-video"></i> Acceso a la Clase Virtual</h2>
            
            <div class="zoom-estado">
                <div class="estado-icono">
                    <i class="fas fa-video" id="zoom-icon"></i>
                </div>
                <div class="estado-info">
                    <h3 id="zoom-estado-texto">Clase programada</h3>
                    <p id="zoom-detalle">El enlace estar√° disponible antes de la clase</p>
                </div>
            </div>
            
            <!-- BOT√ìN QUE SE ACTUALIZA AUTOM√ÅTICAMENTE -->
            <a href="#" id="boton-zoom" class="btn btn-zoom" target="_blank">
                <i class="fas fa-door-open" id="zoom-btn-icon"></i>
                <span id="zoom-btn-text">Unirme a la Clase</span>
            </a>
            
            <div class="zoom-preparacion">
                <h3><i class="fas fa-clipboard-check"></i> Preparaci√≥n:</h3>
                <ul id="lista-preparacion">
                    <li><i class="fas fa-check-circle"></i> Tener instalado el software necesario</li>
                    <li><i class="fas fa-check-circle"></i> Conexi√≥n estable a internet</li>
                </ul>
            </div>
        </section>

        <section class="clase-card card-contenidos">
            <h2><i class="fas fa-map-signs"></i> Lo que Exploraremos Hoy</h2>
            <ul class="lista-contenidos" id="lista-contenidos">
                <li><i class="fas fa-compass"></i> <strong>Cargando contenidos...</strong></li>
            </ul>
        </section>
        
        <!-- Enlace a materiales -->
        <section class="clase-card card-materiales">
            <h2><i class="fas fa-folder-open"></i> Materiales de la Clase</h2>
            <p>Accede a gu√≠as, c√≥digos y recursos adicionales para esta clase.</p>
            <a href="materiales.html" class="btn btn-primary" style="display: inline-block; margin-top: 1rem;">
                <i class="fas fa-book"></i> Ver materiales
            </a>
        </section>
    </main>

    <nav class="plataforma-nav">
        <a href="dashboard.html" class="nav-item">
            <i class="fas fa-home"></i>
            <span>Inicio</span>
        </a>
        <a href="clase.html" class="nav-item activo">
            <i class="fas fa-video"></i>
            <span>Clase</span>
        </a>
        <a href="materiales.html" class="nav-item">
            <i class="fas fa-folder-open"></i>
            <span>Materiales</span>
        </a>
    </nav>

    <script>
        // ============================================
        // CONFIGURACI√ìN DE API - CORREGIDA ‚úÖ
        // ============================================
        const API_CONFIG = {
            baseURL: window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
                ? 'http://localhost:3000/api'
                : 'https://plataforma.roboworks.site/api'  // ‚úÖ URL CORRECTA DE PRODUCCI√ìN
        };

        console.log('üåç API Config:', API_CONFIG);

        const apiClient = {
            async get(endpoint) {
                try {
                    const response = await fetch(`${API_CONFIG.baseURL}${endpoint}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        credentials: 'include'
                    });

                    if (!response.ok) {
                        if (response.status === 401) {
                            console.log('üîí Sesi√≥n expirada, redirigiendo a login...');
                            window.location.href = 'login.html';
                            throw new Error('Sesi√≥n expirada');
                        }
                        const error = await response.json().catch(() => ({}));
                        throw new Error(error.message || `Error ${response.status}`);
                    }

                    return await response.json();
                } catch (error) {
                    console.error('‚ùå Error en GET:', error);
                    throw error;
                }
            }
        };

        // Variables globales
        let claseActual = null;
        let studentClasses = [];

        // ============================================
        // INICIALIZACI√ìN
        // ============================================
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('üîç Iniciando p√°gina de clase...');
                
                // Verificar sesi√≥n
                const session = await apiClient.get('/auth/verify');
                console.log('‚úÖ Sesi√≥n v√°lida:', session.user);
                
                // Actualizar avatar si tiene foto
                if (session.user?.profile_photo) {
                    document.getElementById('user-avatar').innerHTML = 
                        `<img src="${session.user.profile_photo}" style="width: 100%; height: 100%; object-fit: cover;">`;
                }
                
                // Cargar datos del estudiante
                await loadStudentData();
                
                // Mostrar fecha actual
                mostrarFecha();
                
                // Actualizar cada minuto el estado del Zoom
                setInterval(actualizarZoom, 60000);
                
            } catch (error) {
                console.error('‚ùå Error al cargar:', error);
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
            }
        });

        // ============================================
        // CARGAR DATOS DEL ESTUDIANTE
        // ============================================
        async function loadStudentData() {
            try {
                console.log('üì• Cargando dashboard del estudiante...');
                const dashboard = await apiClient.get('/student/dashboard');
                console.log('‚úÖ Dashboard cargado:', dashboard);
                
                studentClasses = dashboard.classes || [];
                
                // Si hay clases, mostrar la primera (o la pr√≥xima)
                if (studentClasses.length > 0) {
                    // Buscar la pr√≥xima clase (la primera en el array podr√≠a ser la pr√≥xima)
                    claseActual = studentClasses[0];
                    updateClassInfo(claseActual);
                    
                    // Configurar datos de Zoom
                    setupZoomData(claseActual);
                } else {
                    // No hay clases
                    document.getElementById('clase-titulo').textContent = 'No tienes clases asignadas';
                    document.getElementById('clase-subtitulo').textContent = 'Contacta al administrador';
                    document.getElementById('zoom-section').style.display = 'none';
                }
                
            } catch (error) {
                console.error('‚ùå Error cargando datos:', error);
            }
        }

        // ============================================
        // ACTUALIZAR INFORMACI√ìN DE LA CLASE
        // ============================================
        function updateClassInfo(clase) {
            document.getElementById('clase-etiqueta').textContent = clase.program_name || 'Clase';
            document.getElementById('clase-titulo').textContent = clase.name;
            document.getElementById('clase-subtitulo').textContent = clase.description || 'Prep√°rate para tu clase de rob√≥tica';
            
            // Formatear horario
            const dias = {
                'monday': 'Lunes',
                'tuesday': 'Martes',
                'wednesday': 'Mi√©rcoles',
                'thursday': 'Jueves',
                'friday': 'Viernes',
                'saturday': 'S√°bado'
            };
            const dia = dias[clase.schedule_day] || clase.schedule_day;
            document.getElementById('clase-horario').textContent = `${dia} ${clase.schedule_time || ''}`;
            
            // Objetivo (usamos la descripci√≥n)
            document.getElementById('clase-objetivo').textContent = clase.description || 'Aprender y divertirse con rob√≥tica';
            
            // Contenidos (podr√≠as personalizarlos seg√∫n el programa)
            const contenidos = {
                'CodeWorks': [
                    'Introducci√≥n a la programaci√≥n',
                    'Primeros pasos con Roblox Studio',
                    'Creando tu primer objeto'
                ],
                'Robo-Pro': [
                    'Ensamblaje de robots b√°sicos',
                    'Programaci√≥n de movimientos',
                    'Sensores y actuadores'
                ]
            };
            
            const listaContenidos = document.getElementById('lista-contenidos');
            const items = contenidos[clase.program_name] || [
                'Explorando nuevos conceptos',
                'Actividad pr√°ctica',
                'Proyecto de la clase'
            ];
            
            listaContenidos.innerHTML = items.map(item => 
                `<li><i class="fas fa-compass"></i> <strong>${item}</strong></li>`
            ).join('');
        }

        // ============================================
        // CONFIGURAR DATOS DE ZOOM
        // ============================================
        function setupZoomData(clase) {
            // Crear objeto Zoom con datos de la clase
            const zoomData = {
                clases: [
                    {
                        fecha: new Date().toISOString().split('T')[0], // Hoy (para prueba)
                        hora: clase.schedule_time || '16:00',
                        duracion: 90,
                        enlace: clase.zoom_link || '#',
                        activa: true
                    }
                ]
            };
            
            // Guardar en el elemento script
            const scriptElement = document.getElementById('zoom-data');
            if (!scriptElement) {
                const newScript = document.createElement('script');
                newScript.id = 'zoom-data';
                newScript.type = 'application/json';
                newScript.textContent = JSON.stringify(zoomData);
                document.body.appendChild(newScript);
            } else {
                scriptElement.textContent = JSON.stringify(zoomData);
            }
            
            // Actualizar Zoom
            actualizarZoom();
        }

        // ============================================
        // FECHA ACTUAL
        // ============================================
        function mostrarFecha() {
            const hoy = new Date();
            const opciones = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const fechaStr = hoy.toLocaleDateString('es-EC', opciones);
            document.getElementById('fecha-hoy').textContent = 
                fechaStr.charAt(0).toUpperCase() + fechaStr.slice(1);
        }

        // ============================================
        // L√ìGICA INTELIGENTE DE ZOOM
        // ============================================
        function actualizarZoom() {
            const hoy = new Date();
            const hoyStr = hoy.toISOString().split('T')[0];
            const ahora = hoy.getHours() * 60 + hoy.getMinutes();
            
            try {
                const zoomElement = document.getElementById('zoom-data');
                if (!zoomElement) return;
                
                const zoomData = JSON.parse(zoomElement.textContent);
                const clases = zoomData.clases || [];
                
                const claseHoy = clases.find(c => c.fecha === hoyStr && c.activa);
                
                const boton = document.getElementById('boton-zoom');
                const icono = document.getElementById('zoom-icon');
                const btnIcono = document.getElementById('zoom-btn-icon');
                const btnTexto = document.getElementById('zoom-btn-text');
                const estadoTexto = document.getElementById('zoom-estado-texto');
                const detalle = document.getElementById('zoom-detalle');
                
                if (!claseHoy || !claseHoy.enlace || claseHoy.enlace === '#') {
                    estadoTexto.textContent = 'Enlace no disponible';
                    detalle.textContent = 'El profesor compartir√° el enlace pronto';
                    icono.className = 'fas fa-calendar-times';
                    boton.style.display = 'none';
                    return;
                }
                
                const [horas, minutos] = claseHoy.hora.split(':').map(Number);
                const inicioMinutos = horas * 60 + minutos;
                const finMinutos = inicioMinutos + (claseHoy.duracion || 90);
                
                if (ahora < inicioMinutos - 10) {
                    const minutosFaltan = inicioMinutos - ahora;
                    const horasFaltan = Math.floor(minutosFaltan / 60);
                    const mins = minutosFaltan % 60;
                    
                    estadoTexto.textContent = 'Clase programada';
                    detalle.textContent = `Comienza en ${horasFaltan > 0 ? horasFaltan + 'h ' : ''}${mins}min`;
                    icono.className = 'far fa-clock';
                    btnIcono.className = 'fas fa-lock';
                    btnTexto.textContent = 'Disponible 10 min antes';
                    boton.href = '#';
                    boton.classList.add('btn-deshabilitado');
                    
                } else if (ahora >= inicioMinutos - 10 && ahora < inicioMinutos) {
                    estadoTexto.textContent = '¬°Clase por comenzar!';
                    detalle.textContent = 'El enlace ya est√° disponible';
                    icono.className = 'fas fa-hourglass-end';
                    btnIcono.className = 'fas fa-door-open';
                    btnTexto.textContent = 'Unirme a la Clase';
                    boton.href = claseHoy.enlace;
                    boton.classList.remove('btn-deshabilitado');
                    
                } else if (ahora >= inicioMinutos && ahora <= finMinutos) {
                    const minutosTrans = ahora - inicioMinutos;
                    estadoTexto.textContent = '¬°Clase en sesi√≥n!';
                    detalle.textContent = `Minuto ${minutosTrans} de ${claseHoy.duracion}`;
                    icono.className = 'fas fa-play-circle';
                    btnIcono.className = 'fas fa-door-open';
                    btnTexto.textContent = 'Unirse ahora';
                    boton.href = claseHoy.enlace;
                    boton.classList.remove('btn-deshabilitado');
                    
                } else {
                    const minutosPasaron = ahora - finMinutos;
                    const horasPasaron = Math.floor(minutosPasaron / 60);
                    
                    estadoTexto.textContent = 'Clase finalizada';
                    detalle.textContent = horasPasaron > 0 
                        ? `Finaliz√≥ hace ${horasPasaron}h` 
                        : `Finaliz√≥ hace ${minutosPasaron}min`;
                    icono.className = 'fas fa-check-circle';
                    btnIcono.className = 'fas fa-check';
                    btnTexto.textContent = 'Clase Completada';
                    boton.href = '#';
                    boton.classList.add('btn-deshabilitado');
                }
                
                boton.style.display = 'block';
                
            } catch (e) {
                console.error('Error cargando datos Zoom:', e);
            }
        }
    </script>
</body>
</html>